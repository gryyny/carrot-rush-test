var gdjs;(function(n){const i=new n.Logger("Multiplayer");let W;(function(t){t.disableMultiplayerForTesting=!1;let P=null,k=!1,R=!1,E=!1;t._isLobbyGameRunning=!1;let A=!1,f=null,y=null;t._lobby=null;let v=[],C=null,c=null,G=null,U=null;const S=1e4,J=3e4;let w=!1;t.playerNumber=null,n.registerRuntimeScenePreEventsCallback(e=>{w=e.getGame().isUsingGDevelopDevelopmentEnvironment(),!t.disableMultiplayerForTesting&&(n.multiplayerMessageManager.handleChangeInstanceOwnerMessagesReceived(e),n.multiplayerMessageManager.handleUpdateInstanceMessagesReceived(e),n.multiplayerMessageManager.handleCustomMessagesReceived(),n.multiplayerMessageManager.handleAcknowledgeMessagesReceived(),n.multiplayerMessageManager.resendClearOrCancelAcknowledgedMessages(e),n.multiplayerMessageManager.handleChangeVariableOwnerMessagesReceived(e),n.multiplayerMessageManager.handleUpdateGameMessagesReceived(e),n.multiplayerMessageManager.handleUpdateSceneMessagesReceived(e),n.multiplayerMessageManager.handleHeartbeatsToSend(),n.multiplayerMessageManager.handleDisconnectedPeers(e))}),n.registerRuntimeScenePostEventsCallback(e=>{t.disableMultiplayerForTesting||(n.multiplayerMessageManager.handleDestroyInstanceMessagesReceived(e),n.multiplayerVariablesManager.handleChangeVariableOwnerMessagesToSend(),n.multiplayerMessageManager.handleUpdateGameMessagesToSend(e),n.multiplayerMessageManager.handleUpdateSceneMessagesToSend(e),n.multiplayerMessageManager.handleHeartbeatsReceived(),F(e),n.multiplayerMessageManager.clearDisconnectedPeers())}),n.registerRuntimeScenePostEventsCallback(()=>{t.disableMultiplayerForTesting||(E=!1,A=!1)});const B=({runtimeGame:e,gameId:o})=>{const a="https://gd.games",s=new URL(`${a}/games/${o}/lobbies${f?`/${f}`:""}`);s.searchParams.set("gameVersion",e.getGameData().properties.version),e.getAdditionalOptions().nativeMobileApp&&s.searchParams.set("nativeMobileApp","true"),s.searchParams.set("isPreview",e.isPreview()?"true":"false"),w&&s.searchParams.set("dev","true"),y&&s.searchParams.set("connectionId",y),t.playerNumber&&s.searchParams.set("positionInLobby",t.playerNumber.toString());const l=n.playerAuthentication.getUserId();l&&s.searchParams.set("playerId",l);const r=n.playerAuthentication.getUserToken();return r&&s.searchParams.set("playerToken",r),s.toString()};t.hasLobbyGameJustStarted=()=>E,t.isLobbyGameRunning=()=>t._isLobbyGameRunning,t.hasLobbyGameJustEnded=()=>A,t.getPlayersInLobbyCount=()=>!t._isLobbyGameRunning&&t._lobby?t._lobby.players.length:t._isLobbyGameRunning?n.multiplayerMessageManager.getNumberOfConnectedPlayers():0,t.getCurrentPlayerNumber=()=>t.playerNumber||0,t.isPlayerHost=()=>t.playerNumber===1;const x=e=>{if(!t._lobby)return"";const o=e-1;return o<0||o>=t._lobby.players.length?"":t._lobby.players[o].playerId};t.getPlayerUsername=e=>{const o=x(e);if(!o)return"";const a=v.find(s=>s.id===o);return a?a.username:`Player ${e}`},t.getCurrentPlayerUsername=()=>{const e=t.getCurrentPlayerNumber();return t.getPlayerUsername(e)};const F=e=>{const o=n.multiplayerMessageManager.getDisconnectedPlayers();if(o.length>0)for(const a of o){const s=x(a);if(!s)return;const l=v.find(r=>r.id===s);l&&n.multiplayerComponents.displayPlayerLeftNotification(e,l&&l.username||"Player")}},_=(e,o,a=0)=>{const l=`${w?"https://api-dev.gdevelop.io":"https://api.gdevelop.io"}/game/public-game/${o}`;return fetch(l,{method:"HEAD"}).then(r=>r.status!==200?(i.warn(`Error while fetching the game: ${r.status} ${r.statusText}`),r.status===404||a>2?!1:_(e,o,a+1)):!0,r=>(i.error("Error while fetching game:",r),!1))},z=async(e,o)=>{const s=`${o?"https://api-dev.gdevelop.io":"https://api.gdevelop.io"}/user/user-public-profile/${e}`;return(await fetch(s)).json()},K=async e=>{if(!t._lobby)return;const o=t._lobby.players.map(r=>r.playerId),a=v.map(r=>r.id),s=o.filter(r=>!a.includes(r)),l=a.filter(r=>!o.includes(r));if(!(s.length===0&&l.length===0)){if(s.length>0){const r=await Promise.all(s.map(async g=>await z(g,e)));v=[...v,...r]}l.length>0&&(v=v.filter(g=>!l.includes(g.id)))}},Y=function(e,o){if(y){i.info("Already connected to a lobby.");return}c&&(i.warn("Already connected to a lobby. Closing the previous one."),c.close(),y=null,t.playerNumber=null,f=null,t._lobby=null,c=null);const a=n.projectData.properties.projectUuid,s=n.playerAuthentication.getUserId(),l=n.playerAuthentication.getUserToken();if(!a){i.error("Cannot open lobbies if the project has no ID.");return}if(!s||!l){i.warn("Cannot open lobbies if the player is not connected.");return}const r=w?"wss://api-ws-dev.gdevelop.io/play":"wss://api-ws.gdevelop.io/play",g=new URL(r);g.searchParams.set("gameId",a),g.searchParams.set("lobbyId",o),g.searchParams.set("playerId",s),g.searchParams.set("connectionType","lobby"),g.searchParams.set("playerGameToken",l),c=new WebSocket(g.toString()),c.onopen=()=>{if(i.info("Connected to the lobby."),G=setInterval(()=>{c&&c.send(JSON.stringify({action:"heartbeat",connectionType:"lobby"}))},S),c){c.send(JSON.stringify({action:"getConnectionId"}));const d=e.getGame().getPlatformInfo();c.send(JSON.stringify({action:"sessionInformation",connectionType:"lobby",isCordova:d.isCordova,devicePlatform:d.devicePlatform,navigatorPlatform:d.navigatorPlatform,hasTouch:d.hasTouch}))}},c.onmessage=d=>{if(d.data){const b=JSON.parse(d.data);switch(b.type){case"connectionId":{const p=b.data,h=p.connectionId,T=p.positionInLobby,ge=p.validIceServers||[],be=p.brokerServerConfig;if(!h||!T){i.error("No connectionId or position received"),n.multiplayerComponents.displayErrorNotification(e),c&&c.close();return}q({runtimeScene:e,connectionId:h,positionInLobby:T,lobbyId:o,playerId:s,playerToken:l,validIceServers:ge,brokerServerConfig:be});break}case"lobbyUpdated":{const p=b.data,h=p.lobby,T=p.positionInLobby;if(!h){i.error("No lobby received");return}Q(e,h,T);break}case"gameCountdownStarted":{X(e);break}case"gameStarted":{const h=b.data.heartbeatInterval||J;Z(e,h);break}case"peerId":{const p=b.data;if(!p){i.error("No message received");return}const h=p.peerId;if(!h){i.error("Malformed message received");return}ne(h);break}}}},c.onclose=()=>{if(i.info("Disconnected from the lobby. Either manually or game started."),y=null,c=null,G&&clearInterval(G),t._isLobbyGameRunning)return;const d=n.multiplayerComponents.getLobbiesIframe(e);!d||!d.contentWindow||d.contentWindow.postMessage({id:"lobbyLeft"},"*")}},q=function({runtimeScene:e,connectionId:o,positionInLobby:a,lobbyId:s,playerId:l,playerToken:r,validIceServers:g,brokerServerConfig:d}){if(g.length)for(const p of g)n.evtTools.p2p.useCustomICECandidate(p.urls,p.username,p.credential);d?n.evtTools.p2p.useCustomBrokerServer(d.hostname,d.port,d.path,d.key,d.secure):n.evtTools.p2p.useDefaultBrokerServer(),y=o,t.playerNumber=a,f=s;const b=n.multiplayerComponents.getLobbiesIframe(e);if(!b||!b.contentWindow){i.error("The lobbies iframe is not opened, cannot send the join message.");return}b.contentWindow.postMessage({id:"lobbyJoined",lobbyId:s,playerId:l,playerToken:r,connectionId:y,positionInLobby:a},"https://gd.games")},$=function(){c&&c.close(),y=null,t.playerNumber=null,f=null,t._lobby=null,c=null},Q=function(e,o,a){if(t._lobby=o,o.status==="playing")return;K(w),t.playerNumber=a;const s=n.multiplayerComponents.getLobbiesIframe(e);if(!s||!s.contentWindow){i.info("The lobbies iframe is not opened, not sending message.");return}s.contentWindow.postMessage({id:"lobbyUpdated",positionInLobby:a},"*")},X=function(e){t.getCurrentPlayerNumber()===1&&se();const o=n.multiplayerComponents.getLobbiesIframe(e);if(!o||!o.contentWindow){i.info("The lobbies iframe is not opened, not sending message.");return}o.contentWindow.postMessage({id:"gameCountdownStarted"},"*"),n.multiplayerComponents.hideLobbiesCloseButtonTemporarily(e)},Z=function(e,o){const a=n.evtTools.p2p.getAllPeers();if(!t.isPlayerHost()&&a.length===0){n.multiplayerComponents.displayConnectionErrorNotification(e),$(),t.removeLobbiesContainer(e),N(e);return}if(t.isPlayerHost()){const s=n.projectData.properties.projectUuid,l=n.playerAuthentication.getUserId(),r=n.playerAuthentication.getUserToken();if(!s||!l||!r||!f){i.error("Cannot keep the lobby playing without the game ID or player ID.");return}U=setInterval(async()=>{const g=w?"https://api-dev.gdevelop.io":"https://api.gdevelop.io",d={"Content-Type":"application/json"};let b=`${g}/play/game/${s}/public-lobby/${f}/action/heartbeat`;d.Authorization=`player-game-token ${r}`,b+=`?playerId=${l}`,await fetch(b,{method:"POST",headers:d})},o)}i.info("Lobby game has started."),E=!0,t._isLobbyGameRunning=!0,t.removeLobbiesContainer(e),c&&c.close(),N(e)};t.handleLobbyGameEnded=function(){i.info("Lobby game has ended."),A=!0,t._isLobbyGameRunning=!1,f=null,t._lobby=null,t.playerNumber=null,U&&clearInterval(U),n.evtTools.p2p.disconnectFromAllPeers(),n.multiplayerMessageManager.clearExpectedMessageAcknowledgements()};const ne=function(e){const o=n.evtTools.p2p.getCurrentId();if(!o){i.error("No peerId found, the player does not seem connected to the broker server.");return}if(o===e){i.info("Received our own peerId, ignoring.");return}n.evtTools.p2p.connect(e)},te=function(){if(!c){i.error("No connection to send the start countdown message. Are you connected to a lobby?");return}c.send(JSON.stringify({action:"startGameCountdown",connectionType:"lobby"}))},oe=function(){if(!c){i.error("No connection to send the start countdown message. Are you connected to a lobby?");return}c.send(JSON.stringify({action:"startGame",connectionType:"lobby"}))};t.endLobbyGame=async function(){if(!t.isLobbyGameRunning())return;if(!t.isPlayerHost()){i.error("Only the host can end the game.");return}t._isLobbyGameRunning=!1,n.multiplayerMessageManager.sendEndGameMessage();const e=n.projectData.properties.projectUuid,o=n.playerAuthentication.getUserId(),a=n.playerAuthentication.getUserToken();if(!e||!o||!a||!f){i.error("Cannot end the lobby without the game ID or player ID.");return}const s=w?"https://api-dev.gdevelop.io":"https://api.gdevelop.io",l={"Content-Type":"application/json"};let r=`${s}/play/game/${e}/public-lobby/${f}/action/end`;l.Authorization=`player-game-token ${a}`,r+=`?playerId=${o}`;try{await fetch(r,{method:"POST",headers:l,body:JSON.stringify({gameId:e,lobbyId:f})})}catch(g){i.error("Error while ending the game:",g)}t.handleLobbyGameEnded()};const se=function(){if(!c||!t._lobby){i.error("No connection to send the message. Are you connected to a lobby?");return}const e=n.evtTools.p2p.getCurrentId();if(!e){i.error("No peerId found, the player doesn't seem connected to the broker server.");return}c.send(JSON.stringify({action:"sendPeerId",connectionType:"lobby",peerId:e}))},ae=function(e,o,{checkOrigin:a}){if(!(a&&!["https://gd.games","http://localhost:4000"].includes(o.origin))){if(!o.data.id)throw new Error("Malformed message");switch(o.data.id){case"lobbiesListenerReady":{re(e);break}case"joinLobby":{if(!o.data.lobbyId)throw new Error("Malformed message.");Y(e,o.data.lobbyId);break}case"startGameCountdown":{te();break}case"startGame":{oe();break}case"leaveLobby":{$();break}}}},j=function(e,o){i.error(o),t.removeLobbiesContainer(e),N(e)},re=e=>{const o=n.multiplayerComponents.getLobbiesIframe(e);if(!o||!o.contentWindow)return;const a=e.getGame().getPlatformInfo();o.contentWindow.postMessage({id:"sessionInformation",isCordova:a.isCordova,devicePlatform:a.devicePlatform,navigatorPlatform:a.navigatorPlatform,hasTouch:a.hasTouch},"*")},ie=(e,o)=>{const a=B({runtimeGame:e.getGame(),gameId:o});C=s=>{ae(e,s,{checkOrigin:!0})},window.addEventListener("message",C,!0),n.multiplayerComponents.displayIframeInsideLobbiesContainer(e,a)};t.openLobbiesWindow=async e=>{if(t.isLobbiesWindowOpen(e)||n.playerAuthentication.isAuthenticationWindowOpen())return;const o=n.projectData.properties.projectUuid;if(!o){j(e,"The game ID is missing, the lobbies window cannot be opened.");return}if(k||R)return;if(!e.getGame().getRenderer().getDomElementContainer()){j(e,"The div element covering the game couldn't be found, the lobbies window cannot be displayed.");return}const s=()=>{t.removeLobbiesContainer(e)},l=n.playerAuthentication.getUserId(),r=n.playerAuthentication.getUserToken();if(!l||!r){R=!0;const{status:b}=await n.playerAuthentication.openAuthenticationWindow(e).promise;R=!1,b==="logged"&&t.openLobbiesWindow(e);return}if(n.multiplayerComponents.displayLobbies(e,s),P===null){k=!0;try{P=await _(e.getGame(),o)}catch(b){P=!1,i.error("Error while checking if the game is registered:",b),j(e,"Error while checking if the game is registered.");return}finally{k=!1}}const g=e.getGame().getRenderer().getElectron(),d=g?()=>g.shell.openExternal("https://wiki.gdevelop.io/gdevelop5/publishing/web"):()=>window.open("https://wiki.gdevelop.io/gdevelop5/publishing/web","_blank");n.multiplayerComponents.addTextsToLoadingContainer(e,P,d),P&&ie(e,o)},t.isLobbiesWindowOpen=function(e){return!!n.multiplayerComponents.getLobbiesRootContainer(e)},t.showLobbiesCloseButton=function(e,o){n.multiplayerComponents.changeLobbiesWindowCloseActionVisibility(e,o)},t.removeLobbiesContainer=function(e){de(),n.multiplayerComponents.removeLobbiesContainer(e)};const de=function(){C&&(window.removeEventListener("message",C,!0),C=null)},N=function(e){const o=e.getGame().getRenderer().getCanvas();o&&o.focus()}})(W=n.multiplayer||(n.multiplayer={}))})(gdjs||(gdjs={}));
//# sourceMappingURL=multiplayertools.js.map
